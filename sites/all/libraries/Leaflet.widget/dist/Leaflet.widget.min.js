/*! Leaflet.widget - v0.1.0 - 2016-10-05
* Copyright (c) 2016 Affinity Bridge - Tom Nightingale <tom@affinitybridge.com> (http://affinitybridge.com)
* Licensed BSD */
L.GeoJSONUtil={featureCollection:function(e){return{type:"FeatureCollection",features:e||[]}},feature:function(e,t){return{type:"Feature",geometry:e,properties:t||{}}},latLngsToCoords:function(e){var t=[],n;for(var r=0,i=e.length;r<i;r++)n=L.GeoJSONUtil.latLngToCoord(e[r]),t.push(n);return t},latLngToCoord:function(e){return[e.lng,e.lat]}},L.WidgetFeatureGroup=L.FeatureGroup.extend({initialize:function(e){L.FeatureGroup.prototype.initialize.call(this,e),this._size=e?e.length:0},addLayer:function(e){this._size+=1,L.FeatureGroup.prototype.addLayer.call(this,e)},removeLayer:function(e){this._size-=1,L.FeatureGroup.prototype.removeLayer.call(this,e)},clearLayers:function(){this._size=0,L.FeatureGroup.prototype.clearLayers.call(this)},toGeoJSON:function(){var e=[];return this.eachLayer(function(t){e.push(t.toGeoJSON())}),L.GeoJSONUtil.featureCollection(e)},size:function(){return this._size},getBounds:L.FeatureGroup.prototype.getBounds}),L.widgetFeatureGroup=function(e){return new L.WidgetFeatureGroup(e)},L.Path.include({toGeoJSON:function(){return L.GeoJSONUtil.feature(this.toGeometry())}}),L.FeatureGroup.include({toGeometry:function(){var e=[];return this.eachLayer(function(t){var n=t.toGeometry();if(n.type!=="Point")return;e.push(n.coordinates)}),{type:"MultiPoint",coordinates:e}},isCollection:function(){var e=!1,t=[];return this.eachLayer(function(t){!e&&t.toGeometry().type!=="Point"&&(e=!0)}),e},toGeoJSON:function(){if(this.isCollection()){var e=[];return this.eachLayer(function(t){e.push(t.toGeometry())}),{type:"GeometryCollection",geometries:e}}return L.GeoJSONUtil.feature(this.toGeometry())}}),L.Marker.include({toGeometry:function(){return{type:"Point",coordinates:L.GeoJSONUtil.latLngToCoord(this.getLatLng())}},toGeoJSON:function(){return L.GeoJSONUtil.feature(this.toGeometry())}}),L.Polyline.include({toGeometry:function(){return{type:"LineString",coordinates:L.GeoJSONUtil.latLngsToCoords(this.getLatLngs())}}}),L.Polygon.include({toGeometry:function(){var e=this.getLatLngs();return e.push(e[0]),{type:"Polygon",coordinates:[L.GeoJSONUtil.latLngsToCoords(e)]}}}),L.MultiPolyline.include({toGeometry:function(){var e=[];return this.eachLayer(function(t){e.push(t.toGeometry().coordinates)}),{type:"MultiLineString",coordinates:e}}}),L.MultiPolygon.include({toGeometry:function(){var e=[];return this.eachLayer(function(t){e.push(t.toGeometry().coordinates)}),{type:"MultiPolygon",coordinates:e}}}),L.Map.mergeOptions({widget:!1}),L.Handler.Widget=L.Handler.extend({includes:L.Mixin.Events,options:{multiple:!0,cardinality:0,autoCenter:!0,polyline:{shapeOptions:{drawVectorStyle:{color:"#F0F",clickable:!0}}},polygon:{shapeOptions:{drawVectorStyle:{color:"#F0F",clickable:!0}}},rectangle:!0,circle:!0,marker:!0},initialize:function(e,t){L.Util.setOptions(this,t),L.Handler.prototype.initialize.call(this,e),this._map.drawControl||this._initDraw()},addHooks:function(){this._map&&this.options.attach&&(this._attach=L.DomUtil.get(this.options.attach),this._full=!1,this._cardinality=this.options.multiple?this.options.cardinality:1,this.load(this._attach.value),this._map.on({"draw:created":this._onCreated,layerremove:this._unbind},this),this.vectors.size()>0&&this.options.autoCenter&&this._map.fitBounds(this.vectors.getBounds()))},removeHooks:function(){this._map&&(this._map.removeLayer(this.vectors),this._map.off({"draw:created":this._onCreated,layerremove:this._unbind},this))},_initDraw:function(){this.vectors=L.widgetFeatureGroup().addTo(this._map),this._map.drawControl=(new L.Control.Draw({position:"topright",draw:{polyline:this.options.polyline,polygon:this.options.polygon,rectangle:this.options.rectangle,circle:this.options.circle,marker:this.options.marker},edit:{featureGroup:this.vectors}})).addTo(this._map)},_addVector:function(e){this.vectors.addLayer(e),this._cardinality>0&&this._cardinality<=this.vectors.size()&&(this._full=!0)},_onCreated:function(e){var t=e.layerType,n=e.layer;n&&!this._full&&this._addVector(n)},_unbind:function(e){var t=e.layer;this.vectors.hasLayer(t)&&(this.vectors.removeLayer(t),this._cardinality>this.vectors.size()&&(this._full=!1))},load:function(e){var t,n=function(e,t){this._addVector(t)};if(!e)return;return t=typeof e=="string"?JSON.parse(e):e,L.geoJson(t,{onEachFeature:L.Util.bind(n,this)})},write:function(){var e=this.vectors.toGeoJSON();this._attach.value=JSON.stringify(e)}}),L.Map.addInitHook(function(){if(this.options.widget){var e=this.options.widget;this.widget=new L.Handler.Widget(this,e)}});